function localUpdate()
{
	var rawCom=JSON.parse(localStorage.getItem('locJSON'));
	var newText="";
	for(var i=1; i<rawCom.data.length; i++)
	{
			var linkToAvatar;
			if(rawCom.data[i].userAvatar==null) linkToAvatar="http://static.youcomedy.me/186/img/profile/avatar_small.png";
			else linkToAvatar=rawCom.data[i].userAvatar;
			newText=newText+'<div class="nickName"><a target="_blank" class="avat" href="/user/'+rawCom.data[i].username+'">'+'<img class="avatar" src="'+linkToAvatar+'"><div class="avatarName">'+rawCom.data[i].fullname+"</a><br> пишет:</div> </div><br> ";
			newText=newText+"<div class='text'>"+rawCom.data[i].text+"</div>";
			newText=newText+'<br> <div class="toSH"><a target="_blank" href="http://youcomedy.me/'+rawCom.data[i].content_id+'"><div class="minT">→ к шутке &nbsp;</div> <img class="min" src="'+rawCom.data[i].item_small_image+'"></a></div><hr>';
	}

	newText=newText.replace(new RegExp('(/user/[A-Za-z0-9_]+)', 'g'), "http://youcomedy.me$1");
	document.getElementById("comments").innerHTML=newText;
}

function update() //обновляет комментарии
{
	document.getElementById("but").innerHTML='<img src="images/loader.gif">';
	var xhr = new XMLHttpRequest();
	var pat = new RegExp("/user/[A-Za-z0-9_]+");
	xhr.open("GET", "http://youcomedy.me/commentfeed", true);
	xhr.onreadystatechange = function() {
	  if (xhr.readyState == 4) {
		if(xhr.status != 200) 
		{
			var tmp=document.getElementById("but").style.background;
			document.getElementById("but").innerHTML="<font style='font-size: 14px'>Ошибка подключения</font>";
			document.getElementById("but").style.background="red";
			setTimeout(function() {
				document.getElementById("but").innerHTML='↺';
				document.getElementById("but").style.background=tmp;
			}, 1000);
		} 

		var rawCom=JSON.parse(xhr.responseText);
		localStorage.setItem('locJSON', xhr.responseText); //загрузка в локальную базу
		var newText="";
		for(var i=1; i<rawCom.data.length; i++)
		{
			var linkToAvatar;
			if(rawCom.data[i].userAvatar==null) linkToAvatar="http://static.youcomedy.me/186/img/profile/avatar_small.png";
			else linkToAvatar=rawCom.data[i].userAvatar;
			newText=newText+'<div class="nickName"><a target="_blank" class="avat" href="/user/'+rawCom.data[i].username+'">'+'<img class="avatar" src="'+linkToAvatar+'"><div class="avatarName">'+rawCom.data[i].fullname+"</a><br> пишет:</div> </div><br> ";
			newText=newText+"<div class='text'>"+rawCom.data[i].text+"</div>";
			newText=newText+'<br> <div class="toSH"><a target="_blank" href="http://youcomedy.me/'+rawCom.data[i].content_id+'"><div class="minT">→ к шутке &nbsp;</div> <img class="min" src="'+rawCom.data[i].item_small_image+'"></a></div><hr>';
		}
		newText=newText.replace(new RegExp('(/user/[A-Za-z0-9_]+)', 'g'), "http://youcomedy.me$1");
		document.getElementById("comments").innerHTML=newText;
		document.getElementById("but").innerHTML='↺';
	  }
	}
		xhr.send();
}

function upOnLoad()
{
	localUpdate();
	update();
}


document.getElementById("but").addEventListener("click",update);
document.onload.addListener(upOnLoad());
